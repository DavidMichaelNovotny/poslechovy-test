<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Poslechový test spekter </title>
<!-- SheetJS pro export XLSX (pokud je dostupné) -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<style>
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;line-height:1.4}
  body{margin:0;padding:20px;background:#f6f7fb;color:#111}
  .card{max-width:920px;margin:10px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,40,0.08)}
  h1,h2{margin:0 0 10px}
  label{display:block;margin:8px 0 4px;font-weight:600}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  input[type="text"],select{padding:8px;border-radius:6px;border:1px solid #ccc;min-width:220px}
  button{padding:10px 14px;border-radius:8px;border:0;background:#2b6ef6;color:#fff;cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .muted{color:#666;font-size:0.9rem}
  .scale{display:flex;gap:6px;align-items:center}
  .scale input{display:none}
  .scale label{display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:8px;background:#eee;cursor:pointer;border:1px solid #ddd}
  .scale input:checked + label{background:#2b6ef6;color:#fff;border-color:#2357c7}
  .polarity{margin:12px 0;padding:12px;border-radius:8px;background:#fbfcff;border:1px solid #eef2ff}
  .controls{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .progress{font-weight:600}
  .audio-controls{display:flex;gap:10px;align-items:center}
  .polarity-grid{display:grid;grid-template-columns:1fr;gap:8px}
  @media(min-width:820px){ .polarity-grid{grid-template-columns:repeat(2,1fr)} }
  .export-row{display:flex;gap:10px;align-items:center;margin-top:14px;flex-wrap:wrap}
  .small{font-size:.9rem}
  footer{margin-top:14px;color:#666;font-size:.85rem;text-align:center}
</style>
</head>
<body>
<div class="card" id="app">
  <h1>Poslechový test spekter</h1>
  <div id="intro-screen">
    <p class="muted">Vyplňte prosím své celé jméno a zkušenost s poslechem. Data se uloží spolu s hodnocením. Všechna data budou použita pouze pro vzdělávací účely. </p>
    <label for="name">Celé jméno</label>
    <input id="name" type="text" placeholder="Jméno a Příjmení" />

    <label for="experience">Poslechová zkušenost</label>
    <select id="experience">
      <option value="">-- vyber --</option>
      <option value="Začátečník">Začátečník (žádné zkušenosti)</option>
      <option value="Středně pokročilý">Středně pokročilý (nějaké zkušenosti)</option>
      <option value="Pokročilý">Pokročilý (pravidelný poslech, hudební vzdělání)</option>
      <option value="Odborník">Odborník (akustika/řízení poslechových testů/profesionální práce se zvukem)</option>
    </select>

    <div style="margin-top:12px">
      <label>Režim přehrávání vzorků</label>
      <div class="muted small">Po potvrzení začne BLOK A (20 náhodně seřazených vzorků). Po skončení BLOKU A začne BLOK B se stejnými 20 vzorky v novém náhodném pořadí. Tak je zajištěno, že každá nahrávka se objeví dvakrát a druhá opakování až po přehrání všech prvních.</div>
    </div>

    <div style="margin-top:14px" class="controls">
      <div class="muted small">Ujistěte se, že máte ve složce <code>samples/</code> soubory sample1.wav ... sample20.wav.</div>
      <button id="start-btn">Začít test</button>
    </div>
  </div>

  <div id="test-screen" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <div class="progress" id="progress-text">Blok A — vzorek 0/20</div>
        <div class="muted small" id="sample-info">—</div>
      </div>
      <div class="audio-controls">
        <audio id="audio" controls preload="none"></audio>
      </div>
    </div>

    <hr style="margin:12px 0">

    <div id="polarity-container">
      <div class="muted">Ohodnoťte prosím vzorek pomocí následující škály (vyber jedno ze sedmi čísel pro každou polaritu):</div>
      <div style="margin-top:8px;font-weight:700">ŠKÁLA: 0 - ani jedno, 1 - poněkud, 2 - velmi, 3 - mimořádně</div>

      <div class="polarity-grid" id="polarities">
        <!-- generováno JS -->
      </div>
    </div>

    <div style="margin-top:12px" class="controls">
      <div class="muted small" id="feedback"></div>
      <div>
        <button id="prev-btn" disabled>Zpět</button>
        <button id="next-btn" disabled>Uložit a pokračovat</button>
      </div>
    </div>

    <div class="export-row">
      <button id="download-csv">Stáhnout průběžné výsledky .CSV </button>
      <button id="download-xlsx">Stáhnout průběžné výsledky .XLSX </button>
      <button id="reset-btn" style="background:#e24b4b">Restartovat test</button>
    </div>
  </div>

  
<script>
/* ========= KONFIGURACE =========
 - Pokud máš jiné názvy souborů, uprav pole SAMPLES níže (striktně 20 položek).
 - Každý sample objekt: {id: 1..20, file: 'samples/sample1.wav', label: 'H1' (volitelně)}
*/
const SAMPLES = [
  {id:1,file:'samples/sample1.wav',label:'S1'},
  {id:2,file:'samples/sample2.wav',label:'S2'},
  {id:3,file:'samples/sample3.wav',label:'S3'},
  {id:4,file:'samples/sample4.wav',label:'S4'},
  {id:5,file:'samples/sample5.wav',label:'S5'},
  {id:6,file:'samples/sample6.wav',label:'S6'},
  {id:7,file:'samples/sample7.wav',label:'S7'},
  {id:8,file:'samples/sample8.wav',label:'S8'},
  {id:9,file:'samples/sample9.wav',label:'S9'},
  {id:10,file:'samples/sample10.wav',label:'S10'},
  {id:11,file:'samples/sample11.wav',label:'S11'},
  {id:12,file:'samples/sample12.wav',label:'S12'},
  {id:13,file:'samples/sample13.wav',label:'S13'},
  {id:14,file:'samples/sample14.wav',label:'S14'},
  {id:15,file:'samples/sample15.wav',label:'S15'},
  {id:16,file:'samples/sample16.wav',label:'S16'},
  {id:17,file:'samples/sample17.wav',label:'S17'},
  {id:18,file:'samples/sample18.wav',label:'S18'},
  {id:19,file:'samples/sample19.wav',label:'S19'},
  {id:20,file:'samples/sample20.wav',label:'S20'}
];

const POLARITIES = [
  ["Libozvučný","Nelibozvučný"],
  ["Konsonantní","Disonantní"],
  ["Temný","Jasný"],
  ["Tupý","Ostrý"],
  ["Měkký","Zvonivý"],
  ["Široký","Úzký"],
  ["Jednoduchý","Složitý"],
  ["Tónový","Šumový"],
  ["Plný","Prázdný"],
  ["Jednolitý","Různorodý"]
];

const SCALE_VALUES = [-3,-2,-1,0,1,2,3];

/* ====== interní stav ====== */
let respondent = {name:'', experience:''};
let blockOrderA = [];
let blockOrderB = [];
let currentBlock = 'A';
let positionInBlock = 0; // 0..19
let responses = []; // pole objektů s hodnocením
let audioEl = document.getElementById('audio');
let rng = (n)=>{ // crypto-backed shuffle helper
  const arr = Array.from({length:n},(_,i)=>i);
  for(let i=n-1;i>0;i--){
    const rand = Math.floor((crypto.getRandomValues(new Uint32Array(1))[0]/(2**32))* (i+1));
    [arr[i],arr[rand]] = [arr[rand],arr[i]];
  }
  return arr;
};

function shuffleArrayBySeed(arr){
  const idx = rng(arr.length);
  return idx.map(i=>arr[i]);
}

/* ===== UI references ===== */
const introScreen = document.getElementById('intro-screen');
const testScreen = document.getElementById('test-screen');
const startBtn = document.getElementById('start-btn');
const nextBtn = document.getElementById('next-btn');
const prevBtn = document.getElementById('prev-btn');
const nameInput = document.getElementById('name');
const experienceSelect = document.getElementById('experience');
const progressText = document.getElementById('progress-text');
const sampleInfo = document.getElementById('sample-info');
const polarityContainer = document.getElementById('polarities');
const feedback = document.getElementById('feedback');
const downloadCsvBtn = document.getElementById('download-csv');
const downloadXlsxBtn = document.getElementById('download-xlsx');
const resetBtn = document.getElementById('reset-btn');

/* ===== vytvoření UI polarit ===== */
function buildPolarities(){
  polarityContainer.innerHTML = '';
  POLARITIES.forEach((pair, idx)=>{
    const box = document.createElement('div');
    box.className = 'polarity';
    const title = document.createElement('div');
    title.style.fontWeight='700';
    title.textContent = `${idx+1}. ${pair[0]} — ${pair[1]}`;
    box.appendChild(title);

    const scale = document.createElement('div');
    scale.className = 'scale';
    SCALE_VALUES.forEach(val=>{
      const id = `p_${idx}_${val}`;
      const input = document.createElement('input');
      input.type='radio'; input.name=`pol_${idx}`; input.id=id; input.value=val;
      const label = document.createElement('label');
      label.htmlFor = id;
      label.textContent = val;
      scale.appendChild(input);
      scale.appendChild(label);
    });
    box.appendChild(scale);
    polarityContainer.appendChild(box);
  });
}
buildPolarities();

/* ===== start test ===== */
startBtn.addEventListener('click', ()=>{
  const name = nameInput.value.trim();
  const exp = experienceSelect.value;
  if(!name){ alert('Zadej prosím celé jméno.'); nameInput.focus(); return; }
  if(!exp){ alert('Vyber prosím svou poslechovou zkušenost.'); experienceSelect.focus(); return; }

  respondent.name = name;
  respondent.experience = exp;
  respondent.startTimestamp = new Date().toISOString();

  // vytvoř náhodné pořadí pro BLOK A a B (same set, different shuffle)
  const base = SAMPLES.map(s=>({id:s.id,file:s.file,label:s.label}));
  blockOrderA = shuffleArrayBySeed(base.slice());
  // ensure B is different order (rare collision possible) — reshuffle until different
  do {
    blockOrderB = shuffleArrayBySeed(base.slice());
  } while (arraysEqualOrders(blockOrderA, blockOrderB));
  currentBlock = 'A';
  positionInBlock = 0;
  responses = [];
  introScreen.style.display='none';
  testScreen.style.display='block';
  updateUIForCurrent();
});

function arraysEqualOrders(a,b){
  for(let i=0;i<a.length;i++){
    if(a[i].id !== b[i].id) return false;
  }
  return true;
}

/* ===== aktualizace UI podle stavu ===== */
function getCurrentSample(){
  const order = (currentBlock==='A') ? blockOrderA : blockOrderB;
  return order[positionInBlock];
}
function updateUIForCurrent(){
  const sample = getCurrentSample();
  progressText.textContent = `Blok ${currentBlock} — vzorek ${positionInBlock+1}/${SAMPLES.length}`;
  audioEl.src = sample.file;
  // reset polarities selection to previously saved if navigating back
  const existing = findResponse(currentBlock, positionInBlock);
  POLARITIES.forEach((_,i)=>{
    const radios = document.getElementsByName(`pol_${i}`);
    radios.forEach(r=> r.checked = false );
  });
  if(existing){
    POLARITIES.forEach((_,i)=>{
      const radios = document.getElementsByName(`pol_${i}`);
      radios.forEach(r=> { if(String(r.value) === String(existing[`pol${i}`])) r.checked = true; });
    });
  }
  updateNextState();
  prevBtn.disabled = !(positionInBlock>0 || (currentBlock==='B' && positionInBlock===0));
}

/* find response for block & position */
function findResponse(block, pos){
  return responses.find(r => r.block===block && r.positionInBlock===pos) || null;
}

/* check if all polarities are selected */
function allRated(){
  for(let i=0;i<POLARITIES.length;i++){
    const radios = document.getElementsByName(`pol_${i}`);
    if(!Array.from(radios).some(r=>r.checked)) return false;
  }
  return true;
}

function collectRatingValues(){
  const vals = {};
  POLARITIES.forEach((_,i)=>{
    const radios = document.getElementsByName(`pol_${i}`);
    const sel = Array.from(radios).find(r=>r.checked);
    vals[`pol${i}`] = sel ? Number(sel.value) : null;
  });
  return vals;
}

function updateNextState(){
  nextBtn.disabled = !allRated();
  if(!nextBtn.disabled){
    feedback.textContent = 'Hodnocení připraveno k uložení.';
  } else {
    feedback.textContent = 'Nezapomeňte ohodnotit všechny polarity (všech 10).';
  }
}

/* react to/change selections */
document.addEventListener('change', (e)=>{
  if(e.target && e.target.type==='radio'){
    updateNextState();
  }
});

/* prev/next */
prevBtn.addEventListener('click', ()=>{
  // uložit aktuální (pokud zadáno) a odskočit zpět
  const curResp = collectRatingValues();
  const existing = findResponse(currentBlock, positionInBlock);
  if(allRated()){
    saveResponseForCurrent(curResp, /*overwrite*/ true);
  }
  // navigate back
  if(positionInBlock>0){
    positionInBlock--;
  } else if(currentBlock==='B' && positionInBlock===0){
    currentBlock='A';
    positionInBlock = SAMPLES.length - 1;
  }
  updateUIForCurrent();
});

nextBtn.addEventListener('click', ()=>{
  // ulož hodnoty
  if(!allRated()){ alert('Prosím, ohodnoťte všechny polarity.'); return; }
  const vals = collectRatingValues();
  saveResponseForCurrent(vals, /*overwrite*/ true);

  // posunout dál
  if(positionInBlock < SAMPLES.length - 1){
    positionInBlock++;
  } else if(currentBlock==='A'){
    // přejít do bloku B
    currentBlock='B';
    positionInBlock = 0;
  } else {
    // skončeno
    alert('Test dokončen. Můžete si stáhnout výsledky (CSV/XLSX) nebo test restartovat.');
    // disable next button
  }
  updateUIForCurrent();
});

/* uložení hodnocení (v paměti) */
function saveResponseForCurrent(vals, overwrite=false){
  const sample = getCurrentSample();
  const entry = {
    respondentName: respondent.name,
    experience: respondent.experience,
    startTimestamp: respondent.startTimestamp,
    savedTimestamp: new Date().toISOString(),
    sampleId: sample.id,
    sampleFile: sample.file,
    sampleLabel: sample.label || '',
    block: currentBlock,
    repetition: (currentBlock==='A' ? 1 : 2),
    positionInBlock: positionInBlock,
    // polarities:
    ...vals
  };
  // remove existing for same block & position if overwrite
  responses = responses.filter(r => !(r.block===entry.block && r.positionInBlock===entry.positionInBlock));
  responses.push(entry);
}

/* export CSV/XLSX */
function responsesToTable(){
  // Sort for readability: respondent, block(A then B), positionInBlock
  const sorted = responses.slice().sort((a,b)=>{
    if(a.block !== b.block) return a.block.localeCompare(b.block);
    return a.positionInBlock - b.positionInBlock;
  });
  const header = [
    'respondentName','experience','startTimestamp','savedTimestamp',
    'sampleId','sampleFile','sampleLabel','block','repetition','positionInBlock'
  ];
  for(let i=0;i<POLARITIES.length;i++) header.push(`polarity_${i+1}_${POLARITIES[i][0].replace(/\s+/g,'_')}_vs_${POLARITIES[i][1].replace(/\s+/g,'_')}`);
  const rows = [header];
  sorted.forEach(r=>{
    const base = [
      r.respondentName, r.experience, r.startTimestamp, r.savedTimestamp,
      r.sampleId, r.sampleFile, r.sampleLabel, r.block, r.repetition, r.positionInBlock
    ];
    for(let i=0;i<POLARITIES.length;i++){
      base.push(r[`pol${i}`] ?? '');
    }
    rows.push(base);
  });
  return rows;
}

function downloadCSV(){
  const rows = responsesToTable();
  const csv = rows.map(r => r.map(cell => {
    if(cell === null || cell === undefined) return '';
    const s = String(cell).replace(/"/g,'""');
    return (s.search(/("|,|\n)/g) >= 0) ? `"${s}"` : s;
  }).join(',')).join('\r\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `poslechovy_test_${respondent.name.replace(/\s+/g,'_')}_${(new Date()).toISOString().slice(0,19)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

downloadCsvBtn.addEventListener('click', ()=>{
  if(responses.length===0){ alert('Žádná data k exportu.'); return; }
  downloadCSV();
});

downloadXlsxBtn.addEventListener('click', ()=>{
  if(responses.length===0){ alert('Žádná data k exportu.'); return; }
  if(typeof XLSX === 'undefined'){ alert('Knihovna SheetJS není načtena. CSV je k dispozici.'); return; }
  const rows = responsesToTable();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Responses');
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  const blob = new Blob([wbout],{type:'application/octet-stream'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `poslechovy_test_${respondent.name.replace(/\s+/g,'_')}_${(new Date()).toISOString().slice(0,19)}.xlsx`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* reset */
resetBtn.addEventListener('click', ()=>{
  if(!confirm('Opravdu chceš restartovat test? Všechna nahraná data v této relaci budou ztracena.')) return;
  location.reload();
});

/* dostupnost souboru (nepovinné) — neblokovat, ale zobrazit varování pokud audio 404 */
audioEl.addEventListener('error', (e)=>{
  console.warn('Chyba načtení audio souboru:', audioEl.src);
  feedback.textContent = `Nelze načíst audio: ${audioEl.src} — zkontroluj cestu / názvy souborů.`;
});

/* na konci: udržovat next btn disabled, update progress text při změnách uložených odpovědí */
setInterval(()=>{
  // update progress (count uložených v A+B)
  const countSaved = responses.length;
  const totalToSave = SAMPLES.length * 2;
  document.title = `Poslechový test — ${countSaved}/${totalToSave} uložených`;
}, 1000);

/* Zabezpečení: pokud uživatel skončí test bez exportu, data zůstanou ve stránce; pro perzistenci lze přidat localStorage (neimplementováno nyní). */

/* pomocné: pokud chceš exportovat anonymní dataset více respondentů, spustíš test pro každého a stáhneš CSV/XLSX pro každého respondenta, nebo rozšíříš aplikaci o serverové API která sbírá výsledky centrálně. */

</script>
</body>
</html>
