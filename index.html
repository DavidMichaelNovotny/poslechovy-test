<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Poslechový test spekter</title>
<style>
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;line-height:1.4}
  body{margin:0;padding:20px;background:#f6f7fb;color:#111}
  .card{max-width:920px;margin:10px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,40,0.08)}
  h1,h2{margin:0 0 10px}
  label{display:block;margin:8px 0 4px;font-weight:600}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  input[type="text"],select{padding:8px;border-radius:6px;border:1px solid #ccc;min-width:220px}
  button{padding:10px 14px;border-radius:8px;border:0;background:#2b6ef6;color:#fff;cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .muted{color:#666;font-size:0.9rem}
  .scale{display:flex;gap:6px;align-items:center}
  .scale input{display:none}
  .scale label{display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:8px;background:#eee;cursor:pointer;border:1px solid #ddd}
  .scale input:checked + label{background:#2b6ef6;color:#fff;border-color:#2357c7}
  .polarity{margin:12px 0;padding:12px;border-radius:8px;background:#fbfcff;border:1px solid #eef2ff}
  .controls{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .progress{font-weight:600}
  .audio-controls{display:flex;gap:10px;align-items:center}
  .polarity-grid{display:grid;grid-template-columns:1fr;gap:8px}
  @media(min-width:820px){ .polarity-grid{grid-template-columns:repeat(2,1fr)} }
  .export-row{display:flex;gap:10px;align-items:center;margin-top:14px;flex-wrap:wrap}
  .small{font-size:.9rem}
  footer{margin-top:14px;color:#666;font-size:.85rem;text-align:center}
</style>
</head>
<body>
<div class="card" id="app">
  <h1>Poslechový test spekter</h1>
  <div id="intro-screen">
    <p class="muted">Vyplňte prosím své celé jméno a zkušenost s poslechem. Data se uloží spolu s hodnocením. Všechna data budou použita pouze pro vzdělávací účely. </p>
    <label for="name">Celé jméno</label>
    <input id="name" type="text" placeholder="Jméno a Příjmení" />
    <label for="experience">Poslechová zkušenost</label>
    <select id="experience">
      <option value="">-- vyber --</option>
      <option value="Začátečník">Začátečník (žádné zkušenosti)</option>
      <option value="Středně pokročilý">Středně pokročilý (nějaké zkušenosti)</option>
      <option value="Pokročilý">Pokročilý (pravidelný poslech, hudební vzdělání)</option>
      <option value="Odborník">Odborník (akustika/řízení poslechových testů/profesionální práce se zvukem)</option>
    </select>
    <div style="margin-top:12px">
      <label>Režim přehrávání vzorků</label>
      <div class="muted small">Po potvrzení začne BLOK A (20 náhodně seřazených vzorků). Po skončení BLOKU A začne BLOK B se stejnými 20 vzorky v novém náhodném pořadí. Tak je zajištěno, že každá nahrávka se objeví dvakrát a druhá opakování až po přehrání všech prvních.</div>
    </div>
    <div style="margin-top:14px" class="controls">
      <div class="muted small">Ujistěte se, že máte ve složce <code>samples/</code> soubory sample1.wav ... sample20.wav.</div>
      <button id="start-btn">Začít test</button>
    </div>
  </div>

  <div id="test-screen" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <div class="progress" id="progress-text">Blok A — vzorek 0/20</div>
        <div class="muted small" id="sample-info">—</div>
      </div>
      <div class="audio-controls">
        <audio id="audio" controls preload="none"></audio>
      </div>
    </div>

    <hr style="margin:12px 0">

    <div id="polarity-container">
      <div class="muted">Ohodnoťte prosím vzorek pomocí následující škály (vyber jedno ze sedmi čísel pro každou polaritu):</div>
      <div style="margin-top:8px;font-weight:700">ŠKÁLA: -3 až 3</div>

      <div class="polarity-grid" id="polarities"></div>
    </div>

    <div style="margin-top:12px" class="controls">
      <div class="muted small" id="feedback"></div>
      <div>
        <button id="prev-btn" disabled>Zpět</button>
        <button id="next-btn" disabled>Uložit a pokračovat</button>
      </div>
    </div>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxHOMPWlWN6WpZBoJmJGMvfmyjOSWuAjpequxG8tHekhq61BP0jLVZHUaE6iRxKazVh/exec';

const SAMPLES = [];
for(let i=1;i<=20;i++){
  SAMPLES.push({id:i,file:`samples/sample${i}.wav`,label:`S${i}`});
}

const POLARITIES = [
  ["Libozvučný","Nelibozvučný"],
  ["Konsonantní","Disonantní"],
  ["Temný","Jasný"],
  ["Tupý","Ostrý"],
  ["Měkký","Zvonivý"],
  ["Široký","Úzký"],
  ["Jednoduchý","Složitý"],
  ["Tónový","Šumový"],
  ["Plný","Prázdný"],
  ["Jednolitý","Různorodý"]
];

const SCALE_VALUES = [-3,-2,-1,0,1,2,3];

let respondent = {name:'', experience:''};
let blockOrderA = [], blockOrderB = [];
let currentBlock = 'A';
let positionInBlock = 0;
let responses = [];
let audioEl = document.getElementById('audio');

const introScreen = document.getElementById('intro-screen');
const testScreen = document.getElementById('test-screen');
const startBtn = document.getElementById('start-btn');
const nextBtn = document.getElementById('next-btn');
const prevBtn = document.getElementById('prev-btn');
const nameInput = document.getElementById('name');
const experienceSelect = document.getElementById('experience');
const progressText = document.getElementById('progress-text');
const polarityContainer = document.getElementById('polarities');
const feedback = document.getElementById('feedback');

function rng(n){
  const arr = Array.from({length:n},(_,i)=>i);
  for(let i=n-1;i>0;i--){
    const rand = Math.floor((crypto.getRandomValues(new Uint32Array(1))[0]/(2**32))* (i+1));
    [arr[i],arr[rand]] = [arr[rand],arr[i]];
  }
  return arr;
}
function shuffleArrayBySeed(arr){
  const idx = rng(arr.length);
  return idx.map(i=>arr[i]);
}

function buildPolarities(){
  polarityContainer.innerHTML = '';
  POLARITIES.forEach((pair, idx)=>{
    const box = document.createElement('div'); box.className='polarity';
    const title = document.createElement('div'); title.innerHTML=`<strong>Polarita ${idx+1}:</strong>`;
    box.appendChild(title);
    const grid = document.createElement('div'); grid.className='scale';
    SCALE_VALUES.forEach(val=>{
      const id = `p${idx}_${val}`;
      const radio = document.createElement('input'); radio.type='radio'; radio.name=`pol${idx}`; radio.value=val; radio.id=id;
      const label = document.createElement('label'); label.htmlFor=id; label.innerText=val;
      grid.appendChild(radio); grid.appendChild(label);
    });
    box.appendChild(grid); polarityContainer.appendChild(box);
  });
}

function getCurrentSample(){
  const order = currentBlock==='A'?blockOrderA:blockOrderB;
  return SAMPLES[order[positionInBlock]];
}

function updateProgress(){
  progressText.innerText = `Blok ${currentBlock} — vzorek ${positionInBlock+1}/20`;
  const sample = getCurrentSample();
  document.getElementById('sample-info').innerText = sample.label;
}

function saveResponseForCurrent(){
  const entry = {name:respondent.name, experience:respondent.experience, block:currentBlock, sample:getCurrentSample().label, ratings:{}};
  POLARITIES.forEach((pair, idx)=>{
    const sel = document.querySelector(`input[name="pol${idx}"]:checked`);
    entry.ratings[`p${idx}`] = sel?parseInt(sel.value):null;
  });
  responses.push(entry);
  sendResponseToGAS(entry);
}

function sendResponseToGAS(entry){
  fetch(GAS_URL,{
    method:'POST',
    mode:'no-cors',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(entry)
  }).then(()=>console.log('Odpověď odeslána:', entry.sample))
  .catch(err=>console.error('Chyba při odesílání:', err));
}

function nextSample(){
  saveResponseForCurrent();
  positionInBlock++;
  if(positionInBlock>=SAMPLES.length){
    if(currentBlock==='A'){
      currentBlock='B';
      blockOrderB = shuffleArrayBySeed(SAMPLES);
      positionInBlock=0;
      feedback.innerText='Začíná druhé opakování (Blok B)';
    } else {
      feedback.innerText='Test dokončen, děkujeme!';
      audioEl.src='';
      nextBtn.disabled=true;
      prevBtn.disabled=true;
      return;
    }
  }
  loadSample();
}

function prevSample(){
  if(positionInBlock>0){
    positionInBlock--;
    loadSample();
  }
}

function loadSample(){
  updateProgress();
  const sample = getCurrentSample();
  audioEl.src=sample.file;
  nextBtn.disabled=false;
  prevBtn.disabled = positionInBlock===0;
}

startBtn.onclick = ()=>{
  if(!nameInput.value || !experienceSelect.value){
    alert('Vyplňte prosím své jméno a zkušenosti');
    return;
  }
  respondent.name=nameInput.value; respondent.experience=experienceSelect.value;
  introScreen.style.display='none';
  testScreen.style.display='block';
  blockOrderA = shuffleArrayBySeed(SAMPLES);
  buildPolarities();
  loadSample();
};

nextBtn.onclick = nextSample;
prevBtn.onclick = prevSample;
</script>

</body>
</html>
